<?xml version="1.0" encoding="utf-8"?>
<Window x:Class="FileEncrypter.CertificateSelectionWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:FileEncrypter"
        Title="Seleccionar Certificado PKI"
        Width="800" Height="600"
        WindowStartupLocation="CenterOwner"
        Background="{StaticResource SurfaceBrush}"
        ResizeMode="CanResize"
        MinWidth="600" MinHeight="400">

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock 
                Text="🔐 Seleccionar Certificado PKI" 
                FontSize="24" 
                FontWeight="Bold" 
                Foreground="{StaticResource OnSurfaceBrush}"
                HorizontalAlignment="Center"
                Margin="0,0,0,8"/>
            <TextBlock 
                Text="Selecciona un certificado para encriptar o desencriptar archivos de forma segura"
                FontSize="14" 
                Foreground="{StaticResource OnSurfaceBrush}"
                HorizontalAlignment="Center"
                Opacity="0.8"/>
        </StackPanel>

        <!-- Search and Filter -->
        <Border Grid.Row="1" Style="{StaticResource Card}" Padding="16" Margin="0,0,0,16">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBox 
                    Grid.Column="0"
                    x:Name="SearchTextBox"
                    Style="{StaticResource ModernTextBox}"
                    Padding="12,8"
                    FontSize="14"
                    Text=""
                    TextChanged="SearchTextBox_TextChanged">
                    <TextBox.Template>
                        <ControlTemplate TargetType="TextBox">
                            <Border Background="{TemplateBinding Background}"
                                    BorderBrush="{TemplateBinding BorderBrush}"
                                    BorderThickness="{TemplateBinding BorderThickness}"
                                    CornerRadius="8">
                                <Grid>
                                    <ScrollViewer x:Name="PART_ContentHost" 
                                                Margin="{TemplateBinding Padding}"
                                                VerticalAlignment="Center"/>
                                    <TextBlock Text="🔍 Buscar certificados..."
                                             Foreground="#FF6B7280"
                                             Margin="{TemplateBinding Padding}"
                                             VerticalAlignment="Center"
                                             IsHitTestVisible="False">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Text, RelativeSource={RelativeSource TemplatedParent}}" Value="">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Grid>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsFocused" Value="True">
                                    <Setter Property="BorderBrush" Value="{StaticResource AccentBrush}"/>
                                    <Setter Property="BorderThickness" Value="2"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </TextBox.Template>
                </TextBox>

                <Button 
                    Grid.Column="1"
                    Content="🔄 Actualizar"
                    Style="{StaticResource FlatButton}"
                    Click="RefreshCertificates_Click"
                    Margin="8,0,0,0"
                    ToolTip="Actualizar lista de certificados"/>

                <CheckBox 
                    Grid.Column="2"
                    x:Name="ShowExpiredCheckBox"
                    Content="Mostrar expirados"
                    Style="{StaticResource ModernCheckBox}"
                    Margin="16,0,0,0"
                    Checked="ShowExpired_Changed"
                    Unchecked="ShowExpired_Changed"/>
            </Grid>
        </Border>

        <!-- Certificates List -->
        <Border Grid.Row="2" Style="{StaticResource Card}" Padding="0">
            <Grid>
                <DataGrid 
                    x:Name="CertificatesDataGrid"
                    Style="{StaticResource ModernDataGrid}"
                    AutoGenerateColumns="False"
                    SelectionMode="Single"
                    CanUserAddRows="False"
                    CanUserDeleteRows="False"
                    CanUserReorderColumns="True"
                    CanUserResizeColumns="True"
                    CanUserSortColumns="True"
                    SelectionChanged="CertificatesDataGrid_SelectionChanged"
                    MouseDoubleClick="CertificatesDataGrid_MouseDoubleClick">
                    
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="📋 Nombre" Binding="{Binding FriendlyName}" Width="200" IsReadOnly="True"/>
                        <DataGridTextColumn Header="🏢 Emisor" Binding="{Binding Issuer}" Width="*" IsReadOnly="True"/>
                        <DataGridTextColumn Header="📅 Válido Hasta" Binding="{Binding ValidTo, StringFormat=dd/MM/yyyy}" Width="120" IsReadOnly="True"/>
                        <DataGridTemplateColumn Header="🔑 Clave Privada" Width="100">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock HorizontalAlignment="Center">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Text" Value="No"/>
                                                <Setter Property="Foreground" Value="#FFEF4444"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding HasPrivateKey}" Value="True">
                                                        <Setter Property="Text" Value="Sí"/>
                                                        <Setter Property="Foreground" Value="#FF10B981"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTextColumn Header="🆔 Huella Digital" Binding="{Binding Thumbprint}" Width="150" IsReadOnly="True">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="TextBlock">
                                    <Setter Property="FontFamily" Value="Consolas"/>
                                    <Setter Property="FontSize" Value="11"/>
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Loading indicator -->
                <StackPanel x:Name="LoadingPanel" 
                           HorizontalAlignment="Center" 
                           VerticalAlignment="Center"
                           Visibility="Collapsed">
                    <TextBlock 
                        Text="🔄" 
                        FontSize="48" 
                        HorizontalAlignment="Center"
                        Foreground="{StaticResource AccentBrush}">
                        <TextBlock.RenderTransform>
                            <RotateTransform x:Name="LoadingRotation"/>
                        </TextBlock.RenderTransform>
                        <TextBlock.Triggers>
                            <EventTrigger RoutedEvent="Loaded">
                                <BeginStoryboard>
                                    <Storyboard RepeatBehavior="Forever">
                                        <DoubleAnimation 
                                            Storyboard.TargetName="LoadingRotation" 
                                            Storyboard.TargetProperty="Angle" 
                                            From="0" To="360" Duration="0:0:2"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </EventTrigger>
                        </TextBlock.Triggers>
                    </TextBlock>
                    <TextBlock 
                        Text="Cargando certificados..." 
                        FontSize="16" 
                        Foreground="{StaticResource OnSurfaceBrush}"
                        HorizontalAlignment="Center"
                        Margin="0,16,0,0"/>
                </StackPanel>

                <!-- No certificates message -->
                <StackPanel x:Name="NoCertificatesPanel" 
                           HorizontalAlignment="Center" 
                           VerticalAlignment="Center"
                           Visibility="Collapsed">
                    <TextBlock 
                        Text="📋" 
                        FontSize="48" 
                        HorizontalAlignment="Center"
                        Foreground="#FF6B7280"
                        Margin="0,0,0,16"/>
                    <TextBlock 
                        Text="No se encontraron certificados válidos" 
                        FontSize="16" 
                        FontWeight="SemiBold"
                        Foreground="{StaticResource OnSurfaceBrush}"
                        HorizontalAlignment="Center"
                        Margin="0,0,0,8"/>
                    <TextBlock 
                        Text="Instala certificados PKI en el almacén de certificados de Windows"
                        FontSize="14" 
                        Foreground="#FF6B7280"
                        HorizontalAlignment="Center"
                        TextWrapping="Wrap"
                        TextAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Certificate Details -->
        <Border Grid.Row="3" x:Name="DetailsPanel" Style="{StaticResource Card}" Margin="0,16,0,0" Visibility="Collapsed">
            <StackPanel>
                <TextBlock 
                    Text="📋 Detalles del Certificado" 
                    FontSize="16" 
                    FontWeight="Bold" 
                    Foreground="{StaticResource OnSurfaceBrush}"
                    Margin="0,0,0,12"/>
                
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Sujeto:" FontWeight="SemiBold" Margin="0,0,16,4" Foreground="{StaticResource OnSurfaceBrush}"/>
                    <TextBlock Grid.Row="0" Grid.Column="1" x:Name="SubjectText" Text="" Margin="0,0,0,4" Foreground="{StaticResource OnSurfaceBrush}"/>

                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Emisor:" FontWeight="SemiBold" Margin="0,0,16,4" Foreground="{StaticResource OnSurfaceBrush}"/>
                    <TextBlock Grid.Row="1" Grid.Column="1" x:Name="IssuerText" Text="" Margin="0,0,0,4" Foreground="{StaticResource OnSurfaceBrush}"/>

                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Validez:" FontWeight="SemiBold" Margin="0,0,16,4" Foreground="{StaticResource OnSurfaceBrush}"/>
                    <TextBlock Grid.Row="2" Grid.Column="1" x:Name="ValidityText" Text="" Margin="0,0,0,4" Foreground="{StaticResource OnSurfaceBrush}"/>

                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Huella:" FontWeight="SemiBold" Margin="0,0,16,0" Foreground="{StaticResource OnSurfaceBrush}"/>
                    <TextBlock Grid.Row="3" Grid.Column="1" x:Name="ThumbprintText" Text="" FontFamily="Consolas" FontSize="12" Foreground="{StaticResource OnSurfaceBrush}"/>
                </Grid>
            </StackPanel>
        </Border>

        <!-- Action Buttons -->
        <Grid Grid.Row="4" Margin="0,20,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <Button 
                Grid.Column="0"
                Content="📋 Administrar Certificados"
                Style="{StaticResource FlatButton}"
                Click="ManageCertificates_Click"
                ToolTip="Abrir administrador de certificados de Windows"/>

            <Button 
                Grid.Column="2"
                x:Name="SelectButton"
                Content="✅ Seleccionar"
                Style="{StaticResource AccentButton}"
                Click="Select_Click"
                IsEnabled="False"
                MinWidth="120"/>

            <Button 
                Grid.Column="3"
                Content="❌ Cancelar"
                Style="{StaticResource FlatButton}"
                Click="Cancel_Click"
                Margin="8,0,0,0"
                MinWidth="120"/>
        </Grid>
    </Grid>

    <Window.Resources>
        <!-- Recursos adicionales si son necesarios -->
    </Window.Resources>
</Window>